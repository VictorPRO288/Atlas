import chromadb
from chromadb.config import Settings
import ollama
import os

# === 1. –ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ Chroma (–ê—Å—Ç—Ä–∞) ===
client = chromadb.Client(Settings(anonymized_telemetry=False))
collection = client.get_or_create_collection(
    name="docs",
    metadata={"hnsw:space": "cosine"}  # <-- –∫–∞–∫ <-> –≤ PG, –Ω–æ –ª–æ–∫–∞–ª—å–Ω–æ
)

# === 2. –ß–∞–Ω–∫–æ–≤–∞–Ω–∏–µ: ~200 —Å–ª–æ–≤, –Ω–∞—Ö–ª—ë—Å—Ç 20 —Å–ª–æ–≤ ===
def chunk_text(text: str, size=200, overlap=20) -> list[str]:
    words = text.split()
    chunks = []
    step = size - overlap
    for i in range(0, len(words), step):
        chunk = " ".join(words[i:i + size])
        if chunk:
            chunks.append(chunk)
    return chunks

# === 3. –≠–º–±–µ–¥–¥–∏–Ω–≥ —á–µ—Ä–µ–∑ –ª–æ–∫–∞–ª—å–Ω—É—é –º–æ–¥–µ–ª—å (nomic-embed-text) ===
def embed(text: str) -> list[float]:
    return ollama.embeddings(model="nomic-embed-text", prompt=text)["embedding"]

# === 4. –ó–∞–≥—Ä—É–∑–∫–∞ –¥–æ–∫—É–º–µ–Ω—Ç–∞ (plain text) ===
def load_and_index(file_path: str):
    with open(file_path, "r", encoding="utf-8") as f:
        text = f.read()
    chunks = chunk_text(text, size=200, overlap=20)
    
    print(f"‚úÇÔ∏è  –†–∞–∑–±–∏—Ç–æ –Ω–∞ {len(chunks)} —á–∞–Ω–∫–æ–≤. –ì–µ–Ω–µ—Ä–∏—Ä—É—é —ç–º–±–µ–¥–¥–∏–Ω–≥–∏...")
    embeddings = [embed(chunk) for chunk in chunks]
    
    collection.add(
        ids=[f"id_{i}" for i in range(len(chunks))],
        embeddings=embeddings,
        documents=chunks
    )
    print("‚úÖ –î–æ–∫—É–º–µ–Ω—Ç –ø—Ä–æ–∏–Ω–¥–µ–∫—Å–∏—Ä–æ–≤–∞–Ω.")

# === 5. –ü–æ–∏—Å–∫ —Ä–µ–ª–µ–≤–∞–Ω—Ç–Ω—ã—Ö —á–∞–Ω–∫–æ–≤ ===
def retrieve(query: str, top_k=3) -> list[str]:
    emb = embed(query)
    results = collection.query(
        query_embeddings=[emb],
        n_results=top_k
    )
    return results["documents"][0]  # —Å–ø–∏—Å–æ–∫ —Å—Ç—Ä–æ–∫

# === 6. –ü–µ—Ä–µ—Ñ–æ—Ä–º—É–ª–∏—Ä–æ–≤–∫–∞ –≤–æ–ø—Ä–æ—Å–∞ (—Å —É—á—ë—Ç–æ–º –∏—Å—Ç–æ—Ä–∏–∏) ===
def rewrite_question(history: list[dict], question: str) -> str:
    ctx = "\n".join(
        f"{'–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å' if m['role']=='user' else '–ê—Å—Å–∏—Å—Ç–µ–Ω—Ç'}: {m['content']}"
        for m in history
    )
    prompt = f"""–ò—Å—Ç–æ—Ä–∏—è –¥–∏–∞–ª–æ–≥–∞:
{ctx}

–ù–æ–≤—ã–π –≤–æ–ø—Ä–æ—Å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è: {question}

–ü–µ—Ä–µ—Ñ–æ—Ä–º—É–ª–∏—Ä—É–π –µ–≥–æ –≤ –æ–¥–Ω–æ —á—ë—Ç–∫–æ–µ, —Ä–∞–∑–≤–µ—Ä–Ω—É—Ç–æ–µ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ-–∑–∞–ø—Ä–æ—Å –¥–ª—è –ø–æ–∏—Å–∫–∞ –≤ –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ö. –ë–µ–∑ –ø–æ—è—Å–Ω–µ–Ω–∏–π ‚Äî —Ç–æ–ª—å–∫–æ –∑–∞–ø—Ä–æ—Å."""
    
    resp = ollama.chat(
        model="qwen2:7b-instruct-q4_K_M",
        messages=[{"role": "user", "content": prompt}],
        options={"temperature": 0.1}
    )
    return resp["message"]["content"].strip()

# === 7. –ì–µ–Ω–µ—Ä–∞—Ü–∏—è —Ñ–∏–Ω–∞–ª—å–Ω–æ–≥–æ –æ—Ç–≤–µ—Ç–∞ ===
def answer_question(history: list[dict], question: str) -> str:
    # –®–∞–≥ 1: –ø–µ—Ä–µ—Ñ–æ—Ä–º—É–ª–∏—Ä–æ–≤–∫–∞
    rewritten = rewrite_question(history, question)
    print(f"üîç –ü–µ—Ä–µ—Ñ–æ—Ä–º—É–ª–∏—Ä–æ–≤–∞–Ω–æ: {rewritten}")
    
    # –®–∞–≥ 2: –ø–æ–∏—Å–∫ —á–∞–Ω–∫–æ–≤
    relevant = retrieve(rewritten, top_k=3)
    context = "\n\n".join(f"[–§—Ä–∞–≥–º–µ–Ω—Ç {i+1}]: {c}" for i, c in enumerate(relevant))
    
    # –®–∞–≥ 3: —Å–±–æ—Ä–∫–∞ –ø—Ä–æ–º–ø—Ç–∞ —Å –∫–æ–Ω—Ç–µ–∫—Å—Ç–æ–º –∏ –∏—Å—Ç–æ—Ä–∏–µ–π
    history_text = "\n".join(
        f"{'–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å' if m['role']=='user' else '–ê—Å—Å–∏—Å—Ç–µ–Ω—Ç'}: {m['content']}"
        for m in history
    )
    
    prompt = f"""–ò—Å–ø–æ–ª—å–∑—É–π –¢–û–õ–¨–ö–û –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –∏–∑ –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞ –Ω–∏–∂–µ, —á—Ç–æ–±—ã –æ—Ç–≤–µ—Ç–∏—Ç—å.

–ö–æ–Ω—Ç–µ–∫—Å—Ç:
{context}

–ò—Å—Ç–æ—Ä–∏—è –¥–∏–∞–ª–æ–≥–∞:
{history_text}

–í–æ–ø—Ä–æ—Å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è: {question}

–û—Ç–≤–µ—Ç (–Ω–∞ —Ä—É—Å—Å–∫–æ–º, –ø–æ –¥–µ–ª—É, –±–µ–∑ –≤–æ–¥—ã):"""
    
    resp = ollama.chat(
        model="qwen2:7b-instruct-q4_K_M",
        messages=[{"role": "user", "content": prompt}],
        options={"temperature": 0.3}
    )
    return resp["message"]["content"].strip()

# === 8. –û—Å–Ω–æ–≤–Ω–æ–π —á–∞—Ç ===
def main():
    print("üìÑ –í–≤–µ–¥–∏—Ç–µ –ø—É—Ç—å –∫ .txt —Ñ–∞–π–ª—É –¥–ª—è –∏–Ω–¥–µ–∫—Å–∞—Ü–∏–∏:")
    path = input().strip()
    load_and_index(path)

    history = []
    print("\nüí¨ –ß–∞—Ç –≥–æ—Ç–æ–≤. –í–≤–µ–¥–∏—Ç–µ '–≤—ã—Ö–æ–¥', —á—Ç–æ–±—ã –∑–∞–≤–µ—Ä—à–∏—Ç—å.")
    
    while True:
        user_input = input("\n–í—ã: ").strip()
        if user_input.lower() in ("–≤—ã—Ö–æ–¥", "exit"):
            break

        history.append({"role": "user", "content": user_input})
        print("‚è≥ –î—É–º–∞—é...")
        answer = answer_question(history, user_input)
        print(f"ü§ñ: {answer}")
        history.append({"role": "assistant", "content": answer})

if __name__ == "__main__":
    main()